#!/bin/bash

# GhostKit pre-commit hook with security checks and code quality gates
# Colors for better visibility
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ğŸ” GhostKit pre-commit hook running...${NC}"

# Check import formatting with isort
echo -e "${BLUE}ğŸ“‹ Checking import sorting...${NC}"
isort --check-only --profile black . || {
  echo -e "${RED}âŒ Import sorting issues found! Run 'isort --profile black .' to fix.${NC}"
  exit 1
}

# Check code formatting with black
echo -e "${BLUE}ğŸ¨ Checking code formatting...${NC}"
black --check . || {
  echo -e "${RED}âŒ Code needs formatting! Run 'black .' to fix.${NC}"
  echo -e "${YELLOW}ğŸ’¡ Tip: Use 'black --diff .' to see proposed changes.${NC}"
  exit 1
}

# Run flake8 syntax check (only critical errors)
echo -e "${BLUE}ğŸ Running syntax check...${NC}"
flake8 . --count --select=E9,F63,F7,F82 --statistics || {
  echo -e "${RED}âŒ Critical syntax errors detected! Fix before committing.${NC}"
  exit 1
}

# Run security checks with bandit (HIGH priority)
echo -e "${BLUE}ğŸ”’ Running security checks...${NC}"
bandit -r . -x tests,docs --severity-level high || {
  echo -e "${RED}âŒ HIGH SEVERITY security issues found! Fix before committing.${NC}"
  echo -e "${YELLOW}ğŸ’¡ Run 'bandit -r <file>' on specific files for details${NC}"
  exit 1
}

# Check for merge conflict markers
echo -e "${BLUE}ğŸ”€ Checking for merge conflict markers...${NC}"
if grep -r "<<<<<<< HEAD" --include="*.py" .; then
  echo -e "${RED}âŒ Found merge conflict markers! Resolve conflicts before committing.${NC}"
  exit 1
fi

# Run critical tests (if environment variable set)
if [ "$RUN_TESTS" = "true" ]; then
  echo -e "${BLUE}ğŸ§ª Running unit tests...${NC}"
  python -m pytest tests/unit/ -v || {
    echo -e "${RED}âŒ Tests failed! Fix before committing.${NC}"
    exit 1
  }
fi

echo -e "${GREEN}âœ… All quality and security gates passed!${NC}"
exit 0
